<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absensi Video Jitsi</title>

<script src="https://meet.jit.si/external_api.js"></script>

<!-- Face API -->
<script defer src="https://unpkg.com/face-api.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; text-align:center }
#jitsi { width:80%; height:400px; margin:auto; background:black }
#camera { display:none }
table { width:80%; margin:auto; background:white; border-collapse:collapse }
th,td { border:1px solid #ccc; padding:8px }
th { background:#eee }
</style>
</head>

<body>

<h2 id="title"></h2>

<div id="jitsi"></div>

<!-- Kamera hanya untuk peserta -->
<video id="camera" width="320" height="240" autoplay muted></video>

<h3 id="adminTitle"></h3>
<table id="table" style="display:none">
<thead>
<tr><th>Nama</th><th>Status</th><th>Waktu</th></tr>
</thead>
<tbody id="data"></tbody>
</table>

<script>
/* =========================
   ROLE HANDLING
========================= */
const params = new URLSearchParams(location.search)
const role = params.get("role") || "peserta"
const nama = params.get("nama") || "Peserta"

/* =========================
   SHARED STORAGE
========================= */
const channel = new BroadcastChannel("absensi_channel")

/* =========================
   JITSI
========================= */
const api = new JitsiMeetExternalAPI("meet.jit.si", {
  roomName: "AbsensiKampus2026",
  parentNode: document.querySelector("#jitsi"),
  userInfo: { displayName: nama }
})

/* =========================
   ADMIN MODE
========================= */
if (role === "admin") {
  document.getElementById("title").innerText = "ADMIN ABSENSI"
  document.getElementById("adminTitle").innerText = "Data Kehadiran"
  document.getElementById("table").style.display = "table"

  channel.onmessage = e => {
    const tbody = document.getElementById("data")
    tbody.innerHTML += `
      <tr>
        <td>${e.data.nama}</td>
        <td>${e.data.status}</td>
        <td>${e.data.waktu}</td>
      </tr>
    `
  }
}

/* =========================
   PESERTA MODE
========================= */
if (role === "peserta") {
  document.getElementById("title").innerText = "PESERTA"

  const video = document.getElementById("camera")
  video.style.display = "block"

  Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("https://justadudewhohacks.github.io/face-api.js/models")
  ]).then(startCamera)

  function startCamera() {
    navigator.mediaDevices.getUserMedia({ video:true })
      .then(stream => video.srcObject = stream)
  }

  video.addEventListener("play", () => {
    setInterval(async () => {
      const result = await faceapi.detectSingleFace(
        video,
        new faceapi.TinyFaceDetectorOptions()
      )

      if (result) {
        channel.postMessage({
          nama: nama,
          status: "HADIR",
          waktu: new Date().toLocaleString()
        })
      }
    }, 5000)
  })
}
</script>

</body>
</html>
