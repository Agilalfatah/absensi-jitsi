<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peserta Absensi</title>

  <!-- Jitsi -->
  <script src="https://meet.jit.si/external_api.js"></script>

  <!-- Face API -->
  <script src="face-api.min.js"></script>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- Firebase Config -->
  <script src="firebase-config.js"></script>

  <style>
    body {
      font-family: Arial;
      text-align: center;
    }

    #video {
      border: 2px solid black;
      margin-top: 10px;
    }

    /* ✅ Jitsi diperbesar */
    #jitsi {
      width: 95%;
      height: 700px;
      margin: 20px auto;
      border: 2px solid #ccc;
    }
  </style>
</head>

<body>

<h2>Peserta Absensi</h2>

<video id="video" width="320" height="240" autoplay muted></video>
<p id="status">Menunggu wajah...</p>

<!-- Jitsi Meeting -->
<div id="jitsi"></div>

<script>
  const nama = prompt("Masukkan nama Anda:");
  if (!nama) {
    alert("Nama wajib diisi");
    location.reload();
  }

  const video = document.getElementById("video");
  const statusText = document.getElementById("status");

  // Load model FaceAPI
  Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("./models")
  ]).then(startVideo);

  function startVideo() {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(() => alert("Kamera tidak bisa diakses"));
  }

  let sudahKirim = false;

  // Face detection loop
  video.addEventListener("play", () => {
    setInterval(async () => {

      const deteksi = await faceapi.detectSingleFace(
        video,
        new faceapi.TinyFaceDetectorOptions()
      );

      if (deteksi && !sudahKirim) {
        sudahKirim = true;
        statusText.innerText = "Wajah terdeteksi ✅ Absensi dikirim";

        const data = {
          nama: nama,
          waktu: new Date().toLocaleString(),
          status: "Hadir"
        };

        // ✅ Kirim ke Firebase pakai push (aman)
        database.ref("absensi").push(data);
      }

    }, 2000);
  });

  // ✅ Jitsi Meeting Besar
  new JitsiMeetExternalAPI("meet.jit.si", {
    roomName: "AbsensiJitsi2026",
    parentNode: document.getElementById("jitsi"),
    width: "100%",
    height: 700,
    userInfo: { displayName: nama }
  });
</script>

</body>
</html>
