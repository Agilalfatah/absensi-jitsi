<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Peserta Absensi</title>

  <!-- Jitsi -->
  <script src="https://meet.jit.si/external_api.js"></script>

  <!-- Face API -->
  <script src="face-api.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

  <!-- Config -->
  <script src="firebase-config.js"></script>
</head>

<body>

<h2>Peserta Absensi</h2>

<video id="video" width="320" height="240" autoplay muted></video>
<p id="status">Menunggu wajah...</p>

<div id="jitsi"></div>

<script>
const nama = prompt("Masukkan nama Anda:");
if (!nama) {
  alert("Nama wajib diisi");
  location.reload();
}

const video = document.getElementById("video");
const statusText = document.getElementById("status");

// Load model
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri('./models')
]).then(startVideo);

function startVideo() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => video.srcObject = stream)
    .catch(err => alert("Kamera tidak bisa diakses"));
}

let sudahKirim = false;

video.addEventListener("play", () => {
  setInterval(async () => {
    const deteksi = await faceapi.detectSingleFace(
      video,
      new faceapi.TinyFaceDetectorOptions()
    );

    if (deteksi && !sudahKirim) {
      sudahKirim = true;
      statusText.innerText = "Wajah terdeteksi âœ…";

      const data = {
        nama: nama,
        waktu: new Date().toLocaleString(),
        status: "Hadir"
      };

      database.ref("absensi/" + nama).set(data);
    }
  }, 2000);
});

// Jitsi
new JitsiMeetExternalAPI("meet.jit.si", {
  roomName: "AbsensiJitsi2026",
  parentNode: document.getElementById("jitsi"),
  userInfo: { displayName: nama }
});
</script>

</body>
</html>
